{{define "main"}}
<div class="col col-6">
    <h3><a href="/c/{{.Chat.ChatId}}">{{.Chat.ChatName}}</a></h3>
    <a class="btn btn-sm btn-light" href="/h/{{.Chat.ChatId}}?limit={{.Limit}}&offset={{.PrevOffset}}">Prev page</a>
    <a class="btn btn-sm btn-light" href="/h/{{.Chat.ChatId}}?limit={{.Limit}}&offset={{.NextOffset}}">Next page</a>
    {{$chatId := .Chat.ChatId}}
    {{$chat := .Chat}}
    <ul class="list-group list-group-flush">
        {{$lastM := 0}}
        {{$lastDate := ""}}
        {{$lastSender := 0}}

        {{range .Messages}}

            <!-- CONDITION RULES FOR CONTENT -->
            {{$needHeader := true}}
            {{$needFooter := true}}
            {{$needDate := false}}
            {{$needSender := false}}
            {{$attachmentsCount := .Attachments | len}}

            {{if ne .MediaAlbumId 0}}
                {{if eq $lastM 0}}
                    <!--media album start-->
                    {{$needHeader = true}}
                    {{$needFooter = false}}
                    {{$lastM = .MediaAlbumId}}
                {{else if eq .MediaAlbumId $lastM}}
                    <!--media continue-->
                    {{$needHeader = false}}
                    {{$needFooter = false}}
                    {{$lastM = .MediaAlbumId}}
                {{else if ne .MediaAlbumId $lastM}}
                    <!--another album start-->
                    {{$needHeader = true}}
                    {{$needFooter = false}}
                    {{$lastM = .MediaAlbumId}}
                {{end}}
            {{else if ne $lastM 0}}
                <!--media album end-->
                {{$needHeader = true}}
                {{$needFooter = true}}
                {{$lastM = 0}}
            {{end}}
            {{if ne $lastDate .DateStr}}
                {{$needDate = true}}
                {{$lastDate = .DateStr}}
            {{end}}
            {{if ne $lastSender .SenderId}}
                {{$needSender = true}}
                {{$lastSender = .SenderId}}
            {{end}}

            <!-- CONTENT -->
            {{if eq $needDate true}}
                <p class="text-center">{{.DateStr}}</p>
            {{end}}

            {{if eq $needHeader true}}
                <li class="list-group-item">
                {{if eq $needSender true}}
                    {{if isMe .SenderId}}ðŸ”µ{{else}}ðŸ”´{{end}}
                    {{if ne $chat.Type "User"}}<a href="/c/{{.SenderId}}">{{.SenderName}}</a><br>{{end}}
                {{end}}
            {{end}}

            {{if .FormattedText}}
                {{.FormattedText | renderText}}
            {{end}}
            {{if .SimpleText}}
                {{.SimpleText}}
            {{end}}


            {{if gt $attachmentsCount 0}}
                {{if eq $needHeader true}}<br>{{end}}
                {{range .Attachments}}
                    <a href="/f/{{.Id}}"><img src="data:image/png;base64, {{.Thumb}}" title="{{.T}}" alt=""/></a>
                {{end}}
            {{end}}
            {{if eq $needHeader true}}
                <small><span class="float-end" title="{{.DateTimeStr}}"><a class="link-secondary" href="/m/{{$chatId}}/{{.MessageId}}">{{.TimeStr}}</a></span></small>
            {{end}}

            {{if eq $needFooter true}}
                </li>
            {{end}}
        {{end}}
    </ul>
    <a class="btn btn-sm btn-light" href="/h/{{.Chat.ChatId}}?limit={{.Limit}}&offset={{.PrevOffset}}">Prev page</a>
    <a class="btn btn-sm btn-light" href="/h/{{.Chat.ChatId}}?limit={{.Limit}}&offset={{.NextOffset}}">Next page</a>

</div>
{{end}}