{{define "main"}}
<div class="col col-6">
    <h3><a href="/c/{{.Chat.ChatId}}">{{.Chat.ChatName}}</a></h3>
    <a class="btn btn-sm btn-light" href="/h/{{.Chat.ChatId}}?limit={{.Limit}}&offset={{.PrevOffset}}">Prev page</a>
    <a class="btn btn-sm btn-light" href="/h/{{.Chat.ChatId}}?limit={{.Limit}}&offset={{.NextOffset}}">Next page</a>
    {{$chat := .Chat}}
    <ul class="list-group">
        {{$lastM := 0}}
        {{$lastDate := ""}}
        {{$lastSender := 0}}

        {{range .Messages}}

            <!-- CONDITION RULES FOR CONTENT -->
            {{$needHeader := true}}
            {{$needFooter := true}}
            {{$needDate := false}}
            {{$needSender := false}}

            {{if ne .MediaAlbumId 0}}
                {{if eq $lastM 0}}
                    <!--media album start-->
                    {{$needHeader = true}}
                    {{$needFooter = false}}
                    {{$lastM = .MediaAlbumId}}
                {{else if eq .MediaAlbumId $lastM}}
                    <!--media continue-->
                    {{$needHeader = false}}
                    {{$needFooter = false}}
                    {{$lastM = .MediaAlbumId}}
                {{else if ne .MediaAlbumId $lastM}}
                    <!--another album start-->
                    {{$needHeader = true}}
                    {{$needFooter = false}}
                    {{$lastM = .MediaAlbumId}}
                {{end}}
            {{else if ne $lastM 0}}
                <!--media album end-->
                {{$needHeader = true}}
                {{$needFooter = true}}
                {{$lastM = 0}}
            {{end}}
            {{if ne $lastDate .DateStr}}
                {{$needDate = true}}
                {{$lastDate = .DateStr}}
            {{end}}
            {{if ne $lastSender .SenderId}}
                {{$needSender = true}}
                {{$lastSender = .SenderId}}
            {{end}}

            <!-- CONTENT -->
            {{if eq $needDate true}}
                <p class="text-center">{{.DateStr}}</p>
                {{$needSender = true}}
            {{end}}

            {{template "message" dict "parent" . "chat" $chat "needHeader" $needHeader "needSender" $needSender  "needFooter" $needFooter}}
        {{end}}
    </ul>
    <a class="btn btn-sm btn-light" href="/h/{{.Chat.ChatId}}?limit={{.Limit}}&offset={{.PrevOffset}}">Prev page</a>
    <a class="btn btn-sm btn-light" href="/h/{{.Chat.ChatId}}?limit={{.Limit}}&offset={{.NextOffset}}">Next page</a>

</div>
{{end}}