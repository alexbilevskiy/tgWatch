{{define "message"}}
    {{if eq .needPrevFooter true}}
        </div></div></div>
    {{end}}

    {{$flexRow := ""}}
    {{$borderColor := ""}}
    {{$cardWidth := 100}}
    {{$realNeedSender := false}}

    {{if eq .needHeader true}}
        {{if eq .chat.Type "User"}}
            {{if isMe .parent.SenderId}}{{$flexRow = "flex-row"}}{{else}}{{$flexRow = "flex-row-reverse"}}{{end}}
            {{if isMe .parent.SenderId}}{{$borderColor = "border-secondary"}}{{else}}{{$borderColor = "border-primary"}}{{end}}
            {{$cardWidth = 45}}
        {{else}}
            {{$flexRow = "flex-row"}}
            {{$borderColor = ""}}
            {{$cardWidth = 75}}
            {{if eq .needSender true}}
                {{$realNeedSender = true}}
            {{end}}
        {{end}}
        <div class="d-flex {{$flexRow}} my-2">
        <div class="card border {{$borderColor}}" style="max-width: {{$cardWidth}}%; min-width: 10%;">
        <div class="card-body p-1">
    {{end}}

    {{if eq $realNeedSender true}}
            <h6 class="card-subtitle mb-2 text-muted"><a href="/c/{{.parent.SenderId}}">{{.parent.SenderName}}</a></h6>
    {{end}}

    {{$rendered := ""}}
    {{if .parent.FormattedText}}
        {{$rendered := .parent.FormattedText | renderText}}
        {{if $rendered}}
            {{$rendered}}<br>
        {{end}}
    {{end}}
    {{if .parent.SimpleText}}
        {{.parent.SimpleText}}
    {{end}}

    {{$attachmentsCount := .parent.Attachments | len}}
    {{if gt $attachmentsCount 0}}
        {{if eq .needHeader true}}{{if ne $rendered ""}}<br>{{end}}{{end}}
        {{range .parent.Attachments}}
            <a href="/f/{{.Id}}">{{if .Thumb}}<img src="data:image/png;base64, {{.Thumb}}" title="{{.T}}" alt=""/>{{else if .Name}}File: {{.Name}}{{else}}link{{end}}</a>
        {{end}}
    {{end}}

    {{if eq .needHeader true}}
        <div class="align-bottom text-end fw-lighter small float-end">
            <span title="{{.parent.DateTimeStr}}">
                <a class="link-secondary" href="/m/{{.chat.ChatId}}/{{.parent.MessageId}}">{{.parent.TimeStr}}</a>
            </span>
        </div>
    {{end}}

    {{if eq .needFooter true}}
            </div></div></div>
    {{end}}
{{end}}